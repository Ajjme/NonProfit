---
title: "EV Report"
author: "Andrew"
date: "2023-04-01"
output:
  html_document:
    css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<img src="image.jpeg" class="logo">
```{r}

```



```{r, include=FALSE}

library(tidyverse)
library(ggplot2)
library(plotly)
library(dplyr)
library(htmlwidgets)
library(jsonlite)
library(leaflet)
library(janitor)
library(ggthemes)
library(plotly)
library(rjson)
```


```{r,include=FALSE}
#not sure why but I had to add another dot to the path
library(readxl)
zev_sales_county <- read_excel("../02_inputs/New_ZEV_Sales_Last_updated_01-18-2023.xlsx", sheet = "County") %>% 
  clean_names()
```
# EV Report
Electric Vehicles (EVs) are revolutionizing the transportation industry by offering an environmentally-friendly alternative to traditional gasoline-powered vehicles. As EVs become more mainstream, understanding the trends and challenges of EV adoption and charging infrastructure is crucial for policymakers, researchers, and EV enthusiasts alike. In this report, we present a comprehensive analysis of new EV sales in California by city and county(with a particular focus on Contra Costa County), featuring interactive graphs that show new EV sales data standardized by the number of cars in those respective cities and counties. We also provide detailed information on EV chargers in each city, including a map of public charger locations, and highlight the federal electric bus program, which is driving the transition to zero-emission buses. All of the data used in this report is sourced from publicly available datasets, ensuring transparency and accountability. Whether you are a policy maker looking to advance sustainable transportation policies, a researcher seeking to understand the latest trends in EV adoption, or an EV enthusiast wanting to stay informed about charging infrastructure, this report is an essential read. Join us on this journey as we explore the latest developments in the EV landscape and the opportunities and challenges that lie ahead.

In addition to new EV sales and charging infrastructure data, this report also includes graphs on key factors related to the EV landscape. This includes the average cost of ownership, battery material sourcing, car fires, and well-to-wheel emissions. By providing a comprehensive analysis of these factors, the report offers a holistic view of the EV landscape in California and empowers readers to make informed decisions about the future of sustainable transportation.

## Contra Costa County City Electric Transportation Rankings
```{r}
# this is a stacked bar graph of standardized 2022 zEV sales and Chargers per car on road, with bonus points given to brentwood for the bus program
```

## ZEV sales for each city Standardized by number of cars registered in the city
```{r}
#This is a standardized ZEV sales for each city in the county
```

The presented graph displays a ranking of 2022 Zero Emission Vehicle (ZEV) car sales, standardized by the number of cars in each city. The data used for this graph was sourced from the California Energy Commission (CEC)

## Charging Stations per car registered in each city
```{r}
#This is a standardized charging stations by car on road for each city in the county
```

```{r}
#brentwood EV Bus program
```
The California Energy Commission (CEC) has launched the School Bus Replacement Program, which aims to replace California's oldest diesel buses with all-new battery electric buses and install supporting charging infrastructure. 
In addition to the School Bus Replacement Program, the California Air Resources Board (CARB) provides funding for electric school buses and supports the transition to a zero-emission school bus fleet. Data on those recipients has not been included in this report. If you know how/where to get that information please reach out.

# Common Counterpoint in EV Adoption

## Well to Wheel CO2 Emission from the DoE
<iframe src="https://widgets.nrel.gov/afdc/electricity-sources-and-emissions/#/?afdc=true&show_state=ca" id="afdc-eset" frameborder="0" scrolling="no" width="100%" height="auto"></iframe><script type="text/javascript">window.addEventListener('message',(event)=>{if(event&&event.data&&event.data.type==='resize-embed-afdc-eset'){document.getElementById("afdc-eset").height=event.data.height;}});</script>

## Average Cost of Ownership
```{r}
#going to make a summary graph with the 4 cars that they have in it
```
Calculate you cost of Ownership https://atlaspolicy.com/fleet-procurement-analysis-tool/

## Car Fires
```{r}
library(htmltools)
# Load the saved HTML file
vehicle_fires_html <- readLines("vehicle_fires.html")

# Display the HTML file using the HTML() function
HTML(paste(vehicle_fires_html, collapse = "\n"))
```

## Battery Material Sourcing
```{r}
#Just make material of the most recent and show that the new ones have less colbalt
```


# California County Level Breakdown

## 2022 ZEV sales by County
```{r, echo=FALSE}
zev_plot <- zev_sales_county %>%
  group_by(county) %>%
  summarise(total_sales = sum(number_of_vehicles)) %>%
  plot_ly(x = ~county, y = ~total_sales, type = "bar",
          marker = list(color = "#636EFA")) %>%
  layout(xaxis = list(title = "County", showgrid = FALSE),
         yaxis = list(title = "Total Number of Vehicles", showgrid = FALSE),
         title = "Total Zero-Emission Vehicle Sales by County",
         margin = list(l = 100, r = 100, t = 100, b = 100),
         plot_bgcolor = "#F4F4F4",
         paper_bgcolor = "#F4F4F4",
         font = list(family = "Helvetica Neue"))

zev_plot
```
### Where Does your County Stack up?

```{r, echo=FALSE}
zev_sales_one_value <- zev_sales_county %>% 
  pivot_wider(names_from = c(fuel_type, make, model), values_from = number_of_vehicles) %>% 
  filter(data_year == 2022) %>%
  mutate(Total_Sales = rowSums(select(., -c(data_year, county)), na.rm = TRUE))

####

url <- 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties <- rjson::fromJSON(file=url)

### add fips to data

urlmap <- "https://raw.githubusercontent.com/kjhealy/fips-codes/master/state_and_county_fips_master.csv"

county_fips_map <- read.csv(urlmap, colClasses=c(fips="character")) %>%
  filter(state == "CA") %>% 
  rename(county = name) %>% 
  mutate(county = ifelse(str_detect(county, " County"), str_replace(county, " County", ""), county))

join_county_fips <- left_join(zev_sales_one_value, county_fips_map, by= "county") %>% 
  drop_na(fips) %>% #out of state
  mutate_at(vars(Total_Sales), as.numeric) %>% 
  #this was really annoying 
  mutate(fips = stringr::str_pad(fips, width = 5, pad = "0")) %>% 
  mutate_at(vars(fips), as.character)%>% 
  mutate_all(~ifelse(is.na(.), 0, .))


### need to check matching--------------------------
g <- list(
  fitbounds = "locations",
  visible = FALSE
)
fig <- plot_ly()
fig <- fig %>% add_trace(
  type="choropleth",
  geojson=counties,
  locations=join_county_fips$fips,
  z=join_county_fips$Total_Sales,
  colorscale="Blues",
  marker=list(line=list(
    width=0)
  )
)
fig <- fig %>% colorbar(title = "Total EV an PHEV Sales")
fig <- fig %>% layout(
  title = "Total EV an PHEV Sales by County"
)

fig <- fig %>% layout(
  geo = g
)

fig
```
## Data Description and Citation

The data used in this analysis includes the following:

- Alternative Fuel Station Locations: This dataset includes the locations of alternative fuel stations in the United States, including electric charging stations, compressed natural gas stations, and hydrogen fueling stations. This data was obtained from the Alternative Fuels Data Center (AFDC) and can be downloaded at https://afdc.energy.gov/data_download/.

- Zero-Emission Vehicle (ZEV) Sales: This dataset includes annual sales data for new ZEVs, including battery electric vehicles and fuel cell electric vehicles, in California. This data was obtained from the California Energy Commission (CEC) and can be downloaded at https://www.energy.ca.gov/data-reports/energy-almanac/zero-emission-vehicle-and-infrastructure-statistics/new-zev-sales.

- Vehicles in Each City: This dataset includes the number of vehicles in each city in California. The data was obtained from the American Community Survey 2022.

When using this data, please cite the following sources:

- Alternative Fuels Data Center (AFDC). (2022). Alternative Fuel Station Locations [Data file]. Retrieved from https://afdc.energy.gov/data_download/

- California Energy Commission (CEC). (2022). Zero-Emission Vehicle (ZEV) Sales [Data file]. Retrieved from https://www.energy.ca.gov/data-reports/energy-almanac/zero-emission-vehicle-and-infrastructure-statistics/new-zev-sales

- United States Census Bureau. (2022). American Community Survey 2022 [Data file]. Retrieved from https://www.census.gov/programs-surveys/acs/data.html
If you have any questions or comments about this report or the data sources used, please feel free to reach out to the author at Ajohns2050@gmail.com.

